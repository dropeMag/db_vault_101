DELIMITER //
CREATE PROCEDURE sp_insert_room(in_size INTEGER, in_floor INTEGER, in_room_type INTEGER)
BEGIN
	CASE
		WHEN ((SELECT id_room_type FROM tb_room_type WHERE id_room_type = in_room_type) IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Room does not exists.';
		WHEN (in_size NOT IN (1, 2, 3)) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid room size.';
		WHEN (in_floor NOT BETWEEN 1 AND 25) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid floor.';
		ELSE
			INSERT INTO tb_room
				(size, floor, id_room_type)
			VALUES
				(in_size, in_floor, in_room_type);
	END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_incident(in_date DATE, in_incident_type INTEGER, in_room INTEGER)
BEGIN
	IF ((SELECT id_incident_type FROM tb_incident_type WHERE id_incident_type = in_incident_type) IS NULL) THEN
		SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Incident type does not exists.';
	ELSEIF ((SELECT id_room FROM tb_room WHERE id_room = in_room) IS NULL) THEN
		SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Room does not exists.';
	ELSE
		INSERT INTO tb_incident
			(date, id_incident_type, id_room)
		VALUES
			(in_date, in_incident_type, in_room);
	END IF;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_special(in_str INTEGER, in_per INTEGER, in_end INTEGER, in_cha INTEGER, in_int INTEGER, in_agi INTEGER, in_luc INTEGER, in_category VARCHAR(10))
BEGIN
	IF (SELECT fn_verify_special(in_str, in_per, in_end, in_cha, in_int, in_agi, in_luc, in_category)) THEN
		IF in_str = 0 THEN SET in_str = NULL; END IF;
		IF in_per = 0 THEN SET in_per = NULL; END IF;
		IF in_end = 0 THEN SET in_end = NULL; END IF;
		IF in_cha = 0 THEN SET in_cha = NULL; END IF;
		IF in_int = 0 THEN SET in_int = NULL; END IF;
		IF in_agi = 0 THEN SET in_agi = NULL; END IF;
		IF in_luc = 0 THEN SET in_luc = NULL; END IF;
    
		INSERT INTO tb_special
		VALUES (DEFAULT, in_str, in_per, in_end, in_cha, in_int, in_agi, in_luc, LOWER(in_category));
	ELSE
		SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'SPECIAL is invalid.';
    END IF;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_storage(in_category VARCHAR(10))
BEGIN
	IF (LOWER(in_category) NOT IN ('outfit', 'weapon', 'pet', 'junk')) THEN
		SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Category is invalid.';
    ELSE
		INSERT INTO tb_storage
		VALUES (DEFAULT, LOWER(in_category));
    END IF;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_outfit(in_name VARCHAR(25), in_qnt INTEGER, in_str INTEGER, in_per INTEGER, in_end INTEGER, in_cha INTEGER, in_int INTEGER, in_agi INTEGER, in_luc INTEGER)
BEGIN
	CASE
		WHEN (in_qnt < 0) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Quantity can not be negative.';

		WHEN (in_name IN (SELECT name FROM tb_outfit)) THEN
			SET @id_outfit = (SELECT id_outfit FROM tb_outfit WHERE name = in_name);
			SET @qnt_outfit = (SELECT quantity FROM tb_outfit WHERE name = in_name);
            
            UPDATE tb_outfit
            SET quantity = @qnt_outfit + in_qnt
            WHERE id_outfit = @id_outfit;

		ELSE
			CALL sp_insert_special(in_str, in_per, in_end, in_cha, in_int, in_agi, in_luc, 'outfit');
            SET @last_insert_special = LAST_INSERT_ID();
            
			CALL sp_insert_storage('outfit');
            SET @last_insert_storage = LAST_INSERT_ID();

            INSERT INTO tb_outfit
            VALUES (default, in_name, in_qnt, @last_insert_special, @last_insert_storage);
    END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_weapon(in_name VARCHAR(25), in_damage VARCHAR(7), in_qnt INTEGER)
BEGIN
	CASE
		WHEN in_qnt < 0 THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Quantity can not be negative.';
		
        WHEN (in_name IN (SELECT name FROM tb_weapon)) THEN
			SET @id_weapon = (SELECT id_weapon FROM tb_weapon WHERE name = in_name);
			SET @qnt_weapon = (SELECT quantity FROM tb_weapon WHERE name = in_name);
            
            UPDATE tb_weapon
            SET quantity = @qnt_weapon + in_qnt
            WHERE id_weapon = @id_weapon;
            
		ELSE
			CALL sp_insert_storage('weapon');
            SET @last_insert_storage = LAST_INSERT_ID();

            INSERT INTO tb_weapon
            VALUES (default, in_name, in_damage, in_qnt, @last_insert_storage);
    END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_pet(in_name VARCHAR(25), in_description VARCHAR(25), in_qnt INTEGER)
BEGIN
	CASE
		WHEN in_qnt < 0 THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Quantity can not be negative.';
		
        WHEN (in_name IN (SELECT name FROM tb_pet)) THEN
			SET @id_pet = (SELECT id_pet FROM tb_pet WHERE name = in_name);
			SET @qnt_pet = (SELECT quantity FROM tb_pet WHERE name = in_name);
            
            UPDATE tb_pet
            SET quantity = @qnt_pet + in_qnt
            WHERE id_pet = @id_pet;
            
		ELSE
			CALL sp_insert_storage('pet');
            SET @last_insert_storage = LAST_INSERT_ID();

            INSERT INTO tb_pet
            VALUES (default, in_name, in_description, in_qnt, @last_insert_storage);
    END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_junk(in_name VARCHAR(25), in_qnt INTEGER)
BEGIN
	CASE
		WHEN in_qnt < 0 THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Quantity can not be negative.';
		
        WHEN (in_name IN (SELECT name FROM tb_junk)) THEN
			SET @id_junk = (SELECT id_junk FROM tb_junk WHERE name = in_name);
			SET @qnt_junk = (SELECT quantity FROM tb_junk WHERE name = in_name);

            UPDATE tb_junk
            SET quantity = @qnt_junk + in_qnt
            WHERE id_junk = @id_junk;
            
		ELSE
			CALL sp_insert_storage('junk');
            SET @last_insert_storage = LAST_INSERT_ID();

            INSERT INTO tb_junk
            VALUES (default, in_name, in_qnt, @last_insert_storage);
    END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_decease(in_decease_type CHAR(1), in_incident_type INTEGER)
BEGIN
	CASE
		WHEN ((SELECT id_decease_type FROM tb_decease_type WHERE id_decease_type = in_decease_type) IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Decease type is invalid.';
		WHEN ((SELECT id_incident_type FROM tb_incident_type WHERE id_incident_type = in_incident_type) IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Incident type is invalid.';
		ELSE
			INSERT INTO tb_decease
            VALUES (DEFAULT, NOW(), in_decease_type, in_incident_type);
    END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_kinship(in_id_mom INTEGER, in_id_dad INTEGER)
BEGIN
	CASE
		WHEN ((SELECT gender FROM tb_dweller WHERE id_dweller = in_id_mom) IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Mother id does not exists.';
		WHEN ((SELECT gender FROM tb_dweller WHERE id_dweller = in_id_mom) != 'f') THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Mother id is not from a Female.';

        WHEN ((SELECT gender FROM tb_dweller WHERE id_dweller = in_id_dad) IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Father id does not exists.';
        WHEN ((SELECT gender FROM tb_dweller WHERE id_dweller = in_id_dad) != 'm') THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Father id is not from a Male.';

		ELSE
			INSERT INTO tb_kinship
            VALUES (DEFAULT, in_id_mom, in_id_dad);
    END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_dweller(in_name VARCHAR(25), in_gender CHAR(1), in_level INTEGER, in_room INTEGER, in_str INTEGER, in_per INTEGER, in_end INTEGER, in_cha INTEGER, in_int INTEGER, in_agi INTEGER, in_luc INTEGER)
BEGIN
	CASE
        WHEN ((SELECT name FROM tb_dweller WHERE LOWER(name) = LOWER(in_name)) IS NOT NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Dweller alredy exists.';
        WHEN (LENGTH(in_name) < 7) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Name too short.';

		WHEN (LOWER(in_gender) NOT IN ('f', 'm')) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Gender is invalid.';

		WHEN (in_level NOT BETWEEN 1 AND 50) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Level is invalid.';
		
        WHEN ((SELECT id_room FROM tb_room WHERE id_room = in_room) IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Room does not exists.';
            
        ELSE
			CALL sp_insert_special(in_str, in_per, in_end, in_cha, in_int, in_agi, in_luc, 'dweller');
            SET @last_insert_special = LAST_INSERT_ID();

			INSERT INTO tb_dweller
				(name, gender, level, status, id_special, id_room)
			VALUES
				(in_name, in_gender, in_level, 0, @last_insert_special, in_room);
	END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_baby(in_name VARCHAR(25), in_gender CHAR(1), in_id_mom INTEGER, in_id_dad INTEGER, in_str INTEGER, in_per INTEGER, in_end INTEGER, in_cha INTEGER, in_int INTEGER, in_agi INTEGER, in_luc INTEGER)
BEGIN
	CASE
        WHEN ((SELECT name FROM tb_dweller WHERE LOWER(name) = LOWER(in_name)) IS NOT NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Dweller alredy exists.';
        WHEN (LENGTH(in_name) < 7) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Name too short.';

		WHEN (LOWER(in_gender) NOT IN ('f', 'm')) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Gender is invalid.';
            
        ELSE
			CALL sp_insert_special(in_str, in_per, in_end, in_cha, in_int, in_agi, in_luc, 'dweller');
            SET @last_insert_special = LAST_INSERT_ID();
            
            CALL sp_insert_kinship(in_id_mom, in_id_dad);
            SET @last_insert_kinship = LAST_INSERT_ID();

			INSERT INTO tb_dweller
				(name, gender, level, status, id_special, id_kinship)
			VALUES
				(in_name, in_gender, 0, 0, @last_insert_special, @last_insert_kinship);
	END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_update_dweller_bonus(in_dweller VARCHAR(25), in_outfit INTEGER, in_weapon INTEGER, in_pet INTEGER)
BEGIN
	SET @update_id_dweller = (SELECT id_dweller FROM tb_dweller WHERE id_dweller LIKE in_dweller OR 
																				 LOWER(name) = LOWER(in_dweller));

	CASE
		WHEN (@update_id_dweller IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Dweller does not exists.';
		WHEN ((SELECT fn_calculate_outfit(in_outfit)) AND in_outfit IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Sum Ting Wong.';
		WHEN ((SELECT fn_calculate_weapon(in_weapon)) AND in_weapon IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Sum Ting Wong.';
		WHEN ((SELECT fn_calculate_pet(in_pet)) AND in_pet IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Sum Ting Wong.';
		ELSE
			UPDATE tb_dweller
			SET id_outfit = in_outfit,
				id_weapon = in_weapon,
				id_pet = in_pet
			WHERE id_dweller = @update_id_dweller;
	END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_update_dweller_special(in_dweller VARCHAR(25), in_str INTEGER, in_per INTEGER, in_end INTEGER, in_cha INTEGER, in_int INTEGER, in_agi INTEGER, in_luc INTEGER)
BEGIN
	SET @update_id_special = (SELECT id_special FROM tb_dweller WHERE id_dweller LIKE in_dweller OR 
																				 LOWER(name) = LOWER(in_dweller));
	
    CASE
		WHEN (@update_id_special IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Dweller does not exists.';
		WHEN NOT (SELECT fn_verify_special(in_str, in_per, in_end, in_cha, in_int, in_agi, in_luc, 'dweller')) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'SPECIAL is invalid.';
		ELSE        
			IF in_str = 0 THEN SET in_str = NULL; END IF;
			IF in_per = 0 THEN SET in_per = NULL; END IF;
			IF in_end = 0 THEN SET in_end = NULL; END IF;
			IF in_cha = 0 THEN SET in_cha = NULL; END IF;
			IF in_int = 0 THEN SET in_int = NULL; END IF;
			IF in_agi = 0 THEN SET in_agi = NULL; END IF;
			IF in_luc = 0 THEN SET in_luc = NULL; END IF;

			UPDATE tb_special
			SET strength = in_str,
				perception = in_per,
				endurance = in_end,
				charisma = in_cha,
				intelligence = in_int,
				agility = in_agi,
				luck = in_luc
			WHERE id_special = @update_id_special;
	END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_update_dweller_status(in_dweller VARCHAR(25), in_lvl INTEGER, in_room INTEGER, in_decease_type CHAR(1), in_incident_type INTEGER)
BEGIN
	SET @update_id_dweller = (SELECT id_dweller FROM tb_dweller WHERE id_dweller LIKE in_dweller OR 
																				 LOWER(name) = LOWER(in_dweller));

	CASE
		WHEN (@update_id_dweller IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Dweller does not exists.';
		WHEN ((in_lvl NOT BETWEEN 1 AND 50) AND (in_lvl IS NOT NULL)) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Level is invalid.';
		WHEN (((SELECT id_room FROM tb_room WHERE id_room = in_room) IS NULL) AND (in_room IS NOT NULL)) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Room does not exists.';
		WHEN (in_decease_type IS NOT NULL) AND (in_incident_type IS NOT NULL) THEN        
			CALL sp_insert_decease(in_decease_type, in_incident_type);
            SET @last_insert_decease = LAST_INSERT_ID();
            
            UPDATE tb_dweller
            SET level = in_lvl,
				status = 1,
				id_decease = @last_insert_decease,
				id_room = in_room
			WHERE id_dweller = @update_id_dweller;
		ELSE
			IF (in_lvl IS NULL) THEN SET in_lvl = (SELECT level FROM tb_dweller WHERE id_dweller = @update_id_dweller); END IF;
			IF (in_room IS NULL) THEN SET in_room = (SELECT id_room FROM tb_dweller WHERE id_dweller = @update_id_dweller); END IF;
            
			UPDATE tb_dweller
            SET level = in_lvl,
				id_room = in_room
			WHERE id_dweller = @update_id_dweller;
    END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_exploration(in_dweller INTEGER, in_duration INTEGER)
BEGIN
	SET @update_id_dweller = (SELECT id_dweller FROM tb_dweller WHERE id_dweller LIKE in_dweller OR 
																				 LOWER(name) = LOWER(in_dweller));

	CASE
		WHEN (@update_id_dweller IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Dweller does not exists.';
		WHEN (in_duration < 0) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Duration can not be negative.';
		ELSE
			INSERT INTO tb_exploration
            VALUES (DEFAULT, in_duration, in_dweller);
	END CASE;
END //
DELIMITER ;



DELIMITER //
CREATE PROCEDURE sp_insert_quest(in_description VARCHAR(25), in_date_begin DATE, in_dweller_1 INTEGER, in_dweller_2 INTEGER, in_dweller_3 INTEGER)
BEGIN
	SET @update_id_dweller_1 = (SELECT id_dweller FROM tb_dweller WHERE id_dweller LIKE in_dweller_1 OR LOWER(name) = LOWER(in_dweller_1));
	SET @update_id_dweller_2 = (SELECT id_dweller FROM tb_dweller WHERE id_dweller LIKE in_dweller_2 OR LOWER(name) = LOWER(in_dweller_2));
	SET @update_id_dweller_3 = (SELECT id_dweller FROM tb_dweller WHERE id_dweller LIKE in_dweller_3 OR LOWER(name) = LOWER(in_dweller_3));

	CASE
		WHEN (@update_id_dweller_1 IS NULL) AND (in_dweller_1 IS NOT NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'First dweller does not exists.';
		WHEN (@update_id_dweller_2 IS NULL) AND (in_dweller_2 IS NOT NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Second dweller does not exists.';
		WHEN (@update_id_dweller_3 IS NULL) AND (in_dweller_3 IS NOT NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Third dweller does not exists.';
		WHEN (in_dweller_1 IS NULL) AND (in_dweller_2 IS NULL) AND (in_dweller_3 IS NULL) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'At least one dweller must be on this quest.';
		WHEN (in_date_begin > NOW()) THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Begin date is invalid.';
		ELSE
			INSERT INTO tb_quest
			VALUES (DEFAULT, in_description, in_date_begin, DATE(NOW()));
            
            SET @last_insert_quest = LAST_INSERT_ID();
            
            IF (in_dweller_1 IS NOT NULL) THEN
				INSERT INTO tb_dweller_quest
				VALUES (in_dweller_1, @last_insert_quest);
            END IF;
            
            IF (in_dweller_2 IS NOT NULL) THEN
				INSERT INTO tb_dweller_quest
				VALUES (in_dweller_2, @last_insert_quest);
            END IF;

            IF (in_dweller_3 IS NOT NULL) THEN
				INSERT INTO tb_dweller_quest
				VALUES (in_dweller_3, @last_insert_quest);
            END IF;
	END CASE;
END //
DELIMITER ;